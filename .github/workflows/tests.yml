name: Tests

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install eppy pandas pydantic numpy pyyaml tqdm plotly pytest

    - name: Test imports
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')

        print('Testing module imports...')

        # Test all core modules
        from features.geometrie.box_generator import BuildingGeometry, SimpleBoxGenerator
        print('✅ geometrie.box_generator')

        from features.hvac.ideal_loads import create_building_with_hvac
        print('✅ hvac.ideal_loads')

        from features.simulation.runner import EnergyPlusRunner, SimulationResult
        print('✅ simulation.runner')

        from features.auswertung.kpi_rechner import KennzahlenRechner, GebaeudeKennzahlen
        print('✅ auswertung.kpi_rechner')

        from features.auswertung.sql_parser import EnergyPlusSQLParser
        print('✅ auswertung.sql_parser')

        from features.auswertung.visualisierung import ErgebnisVisualisierer
        print('✅ auswertung.visualisierung')

        from core.config import get_config, Config
        print('✅ core.config')

        from core.materialien import add_basic_materials
        print('✅ core.materialien')

        print()
        print('All imports successful! ✨')
        "

    - name: Test config loading
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from core.config import get_config

        print('Testing config loading...')
        config = get_config()
        print(f'✅ Config loaded')
        print(f'   EnergyPlus version: {config.energyplus.version}')
        print(f'   Output dir: {config.simulation.output_dir}')
        print(f'   Num processes: {config.simulation.num_processes}')
        print()
        print('Config loading successful! ✨')
        "

    - name: Test BuildingGeometry
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from features.geometrie.box_generator import BuildingGeometry

        print('Testing BuildingGeometry...')
        geometry = BuildingGeometry(
            length=20.0,
            width=12.0,
            height=6.0,
            num_floors=2
        )
        print(f'✅ Geometry created: {geometry.length}m × {geometry.width}m × {geometry.height}m')
        print(f'   Total floor area: {geometry.total_floor_area}m²')
        print(f'   Floor height: {geometry.floor_height}m')
        print()
        print('BuildingGeometry test successful! ✨')
        "

    - name: Run integration tests
      run: |
        pytest tests/ -v --tb=short || echo "⚠️ Integration tests skipped (EnergyPlus not installed)"
